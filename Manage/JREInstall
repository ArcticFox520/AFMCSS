#!/bin/env bash
JREInstall(){
ScreenSizeMenu
Number=$(dialog \
--title "åˆ›å»ºæœåŠ¡å™¨" \
--menu "æ‚¨æƒ³è¦ä½¿ç”¨å“ªä¸ªJavaç‰ˆæœ¬ï¼Ÿ" \
${HEIGHT} ${WIDTH} ${OPTION} \
"1" "ğŸ‘ JRE-Java21" \
"2" "ğŸ¥‘ JRE-Java20" \
"3" "ğŸ¥’ JRE-Java19" \
"4" "ğŸ¥ JRE-Java18" \
"5" "ğŸ JRE-Java17" \
"6" "ğŸ JRE-Java11" \
"7" "ğŸ« JRE-Java8" \
"0" "è¿”å›è„šæœ¬ä¸»èœå•" \
3>&1 1>&2 2>&3)
case ${Number} in
1)
  JavaVersion="21"
  ;;
2)
  JavaVersion="20"
  ;;
3)
  JavaVersion="19"
  ;;
4)
  JavaVersion="18"
  ;;
5)
  JavaVersion="17"
  ;;
6)
  JavaVersion="11"
  ;;
7)
  JavaVersion="8"
  ;;
esac
echo ${JavaVersion} >> version
if [ -e $BHHOME/Server/JRE${JavaVersion} ]
then
  ScreenSizeMsgbox
  dialog --title "ç™½ç‹-Script" \
  --msgbox "æ‚¨çš„å·²å®‰è£…JRE${JavaVersion} \næ— éœ€é‡å¤å®‰è£…" \
  ${HEIGHT} ${WIDTH}
  exit 3
fi
ScreenSizeMsgbox
if $(dialog --title "MCServer-JRE" \
--yes-button "Temurinæ¸…åæº" \
--no-button "Temurinå®˜æ–¹æº" \
--yesno "è¯·é€‰æ‹©æ‚¨çš„JREä¸‹è½½æº" \
${HEIGHT} ${WIDTH})
then
  URL="https://mirrors.tuna.tsinghua.edu.cn/Adoptium"
  JREJavaURL=${URL}/${JavaVersion}/jre/${ARCH}/linux/
  echo -e ${blue}[${green}*${blue}] ${cyan}æ­£åœ¨è·å– ${yellow}ç‰ˆæœ¬ä¿¡æ¯...${background}
  FileName=$(curl ${JREJavaURL} | grep -oP 'href=\K[^ ]+' | tail -n 1 | sed 's/"//g')
  JREDownloadURL=${JREJavaURL}${FileName}
else
  URL="https://ipinfo.io"
  Address=$(curl -sL ${URL} | sed -n 's/.*"country": "\(.*\)",.*/\1/p')
  if [ "${Address}" = "CN" ]
  then
    # å…è´¹æä¾› è¯·å‹¿æ»¥ç”¨
    GitMirror="https://ghproxy.arcticfox.top/"
  fi
  URL="${GitMirror}https://github.com/adoptium/temurin${JavaVersion}-binaries/releases"
  echo -e ${blue}[${green}*${blue}] ${cyan}æ­£åœ¨è·å– ${yellow}ç‰ˆæœ¬ä¿¡æ¯...${background}
  JREJavaVersion=$(curl ${URL} | grep '</h2>' | grep jdk | sed '1s/.*>\(.*\)<.*/\1/p' | head -n 1)
  Version=$(echo ${JREJavaVersion} | sed 's/jdk-//g' | sed 's/+/_/g')
  JREDownloadURL=${URL}/download/${JREJavaVersion}/OpenJDK${JavaVersion}U-debugimage_${ARCH}_linux_hotspot_${Version}.tar.gz
fi
Download JRE.tar.gz ${JREDownloadURL}
if [ -e $BHHOME/Server/JRE${JavaVersion} ]
then
  ScreenSizeMsgbox
  dialog --title "ç™½ç‹-Script" \
  --msgbox "æ‚¨çš„å·²å®‰è£…JRE${JavaVersion} \næ— éœ€é‡å¤å®‰è£…" \
  ${HEIGHT} ${WIDTH}
  exit 3
else
  cd $BHHOME/Server
  mkdir JRE${JavaVersion}
  echo -e ${blue}[${green}*${blue}] ${cyan}æ­£åœ¨è§£å‹ ${yellow}JRE${JavaVersion}...${background}
  pv JRE.tar.gz | tar -zxf - -C JRE${JavaVersion}
  JavaFolder=$(ls JRE${JavaVersion})
  mv JRE${JavaVersion}/${JavaFolder}/* JRE
  rm -rf JRE${JavaVersion}/${JavaFolder}
  echo -e ${blue}[${green}*${blue}] ${cyan}è§£å‹å®Œæˆ.${background}
fi
}

ARCH=$(uname -m)
case "$ARCH" in
  aarch64|arm64|armv8|armv9)
    ARCH="aarch64"
    JREInstall
    ;;
  arm*|aarch32)
    ScreenSizeMsgbox
    dialog --title "ç™½ç‹-Script" \
    --msgbox "ååˆ†æŠ±æ­‰ æ‚¨çš„æ¶æ„ä¸º${ARCH} \næ— æ³•è¿è¡ŒJRE64" \
    ${HEIGHT} ${WIDTH}
    exit 3
    ;;
  x86_64|x64|amd64)
    ARCH="x64"
    JREInstall
    ;;
  i386|i686|x86)  
    ScreenSizeMsgbox
    dialog --title "ç™½ç‹-Script" \
    --msgbox "ååˆ†æŠ±æ­‰ æ‚¨çš„æ¶æ„ä¸º${ARCH} \næ— æ³•è¿è¡ŒJRE64" \
    ${HEIGHT} ${WIDTH}
    exit 3
    ;;
  *)
    ScreenSizeMsgbox
    dialog --title "ç™½ç‹-Script" \
    --msgbox "ååˆ†æŠ±æ­‰ æ‚¨çš„æ¶æ„ä¸º${ARCH} \nå±äºæœªçŸ¥æ¶æ„" \
    ${HEIGHT} ${WIDTH}
    exit 3
    ;;
esac



