#!/bin/env bash
AFHOME=$1
source $AFHOME/Manage/config

ServerName=WebDAV
config=$AFHOME/Manage/config
StartSoftware=$(grep StartSoftware ${config} | sed 's/StartSoftware=//g')
StartSoftwarePath=$AFHOME/Manage/StartSoftware
ConfigPath=$AFHOME/Manage/WebDAV/config.yaml

StartCheck(){
Port=$(grep port ${ConfigPath} | awk '{print $2}')
ScreenSizeMsgbox
if bash ${StartSoftwarePath} ${StartSoftware} list 2>&1 | grep -q ${ServerName} > /dev/null 2>&1
then
  if ncat -z -w 1 127.0.0.1 ${Port}
  then
    return 0
  else
    whiptail --title "WebDAV-SM" \
    --msgbox "ç»ˆç«¯å: ${StartSoftware} [è¢«å ç”¨]" \
    ${HEIGHT} ${WIDTH}
    return 1
  fi
elif ncat -z -w 1 127.0.0.1 ${Port}
then
  if bash ${StartSoftwarePath} ${StartSoftware} list 2>&1 | grep -q ${ServerName} > /dev/null 2>&1
  then
    return 0
  else
    whiptail --title "WebDAV-SM" \
    --msgbox "ç«¯å£: ${Port} [è¢«å ç”¨]" \
    ${HEIGHT} ${WIDTH}
    return 1
  fi
else
  return 2
fi
}

WaitingProgressBar(){
  i=0
  ScreenSizeMsgbox
  Port=$(grep port ${ConfigPath} | awk '{print $2}')
  i=0
  {
    until ncat -zw 0.1 127.0.0.1 ${Port} &> /dev/null
    do
      echo ${i}
      ((i++))
      sleep 0.4s
    done
  } | whiptail --title "WebDAV-SM" --gauge "WebDAVæ­£åœ¨å¯åŠ¨" ${HEIGHT} ${WIDTH} 0
}

ARCH=$(uname -m)
case "$ARCH" in
  aarch64|arm64|armv8|armv9)
    ARCH="arm64"
    ;;
  x86_64|x64|amd64)
    ARCH="amd64"
    ;;
  *)
    ScreenSizeMsgbox
    dialog --title "ç™½ç‹-Script" \
    --msgbox "ååˆ†æŠ±æ­‰ æ‚¨çš„æ¶æ„ä¸º${ARCH} \næ— æ³•è¿è¡ŒWebDAV" \
    ${HEIGHT} ${WIDTH}
    exit 3
    ;;
esac

WebDAVMENU(){
ScreenSizeMenu
Number=$(whiptail \
--title "WebDAV-SM" \
--menu "WebDAVç®¡ç†" \
${HEIGHT} ${WIDTH} ${OPTION} \
"1" "ğŸ€ å¯åŠ¨WebDAV" \
"2" "ğŸŒ¸ å…³é—­WebDAV" \
"3" "ğŸ é…ç½®WebDAV" \
"0" "ğŸ¥ è¿”å›ä¸»èœå•" \
3>&1 1>&2 2>&3)
feedback=$?
if [ ${feedback} == 1 ]
then
  exit
fi
case ${Number} in
1)
  if grep -q admin ${ConfigPath}
  then
    ScreenSizeMsgbox
    username=$(whiptail \
    --title "WebDAV-SM" \
    --inputbox "è¯·è®¾ç½®ç”¨æˆ·å" \
    ${HEIGHT} ${WIDTH} \
    3>&1 1>&2 2>&3)
    password=$(whiptail \
    --title "WebDAV-SM" \
    --passwordbox "è¯·è®¾ç½®å¯†ç " \
    ${HEIGHT} ${WIDTH} \
    3>&1 1>&2 2>&3)
    sed -i "s/ - username: admin/  - username: ${username}/g" ${ConfigPath}
    sed -i "s/   password: admin/    password: ${password}/g" ${ConfigPath}
    sed -i "s|   scope:*|    scope: $AFHOME|g" ${ConfigPath}
  fi
  Command="cd $AFHOME/Manage/WebDAV && ./webdav-${ARCH}"
  bash ${StartSoftwarePath} ${StartSoftware} start ${ServerName} "${Command}"
  WaitingProgressBar
  ScreenSizeMsgbox
  whiptail --title "WebDAV-SM" \
  --msgbox "${ServerName} å¯åŠ¨å®Œæˆ" \
  ${HEIGHT} ${WIDTH}
  ;;
2)
  if StartCheck
  then
    bash ${StartSoftwarePath} ${StartSoftware} stop ${ServerName} > /dev/null 2>&1
  else
    ScreenSizeMsgbox
    whiptail --title "WebDAV-SM" \
    --msgbox "${ServerName} [æœªå¯åŠ¨]" \
    ${HEIGHT} ${WIDTH}
  fi
  ;;
3)
  ScreenSizeMenu
  Number=$(whiptail \
  --title "WebDAV-SM" \
  --menu "WebDAVé…ç½®" \
  ${HEIGHT} ${WIDTH} ${OPTION} \
  "1" "ğŸ€ ä¿®æ”¹ç”¨æˆ·å" \
  "2" "ğŸŒ¸ ä¿®æ”¹å¯†ç " \
  "3" "ğŸ ä¿®æ”¹è·¯å¾„" \
  "4" "ğŸŒ· ç”¨æˆ·éªŒè¯" \
  "0" "ğŸ¥ è¿”å›ä¸»èœå•" \
  3>&1 1>&2 2>&3)
  case ${Number} in
  1)
    ScreenSizeMsgbox
    username=$(whiptail \
    --title "WebDAV-SM" \
    --inputbox "è¯·è¾“å…¥ç”¨æˆ·å" \
    ${HEIGHT} ${WIDTH} \
    3>&1 1>&2 2>&3)
    feedback=$?
    if [ ${feedback} == 1 ]
    then
      return
    fi
    sed -i "s/' - username: admin'/  - username: ${username}/g" ${ConfigPath}
    ScreenSizeMsgbox
    whiptail --title "WebDAV-SM" \
    --msgbox "ä¿®æ”¹å®Œæˆ" \
    ${HEIGHT} ${WIDTH}
    ;;
  2)
    ScreenSizeMsgbox
    password=$(whiptail \
    --title "WebDAV-SM" \
    --passwordbox "è¯·è¾“å…¥å¯†ç " \
    ${HEIGHT} ${WIDTH} \
    3>&1 1>&2 2>&3)
    feedback=$?
    if [ ${feedback} == 1 ]
    then
      return
    fi
    sed -i "s/'   password: admin'/    password: ${password}/g" ${ConfigPath}
    ScreenSizeMsgbox
    whiptail --title "WebDAV-SM" \
    --msgbox "ä¿®æ”¹å®Œæˆ" \
    ${HEIGHT} ${WIDTH}
    ;;
  3)
    ScreenSizeMsgbox
    scope=$(whiptail \
    --title "WebDAV-SM" \
    --inputbox "è¯·è¾“å…¥è·¯å¾„" \
    ${HEIGHT} ${WIDTH} \
    3>&1 1>&2 2>&3)
    feedback=$?
    if [ ${feedback} == 1 ]
    then
      return
    fi
    echo sed -i "s|$(grep scope ${ConfigPath})|    scope: ${scope}|g" ${ConfigPath}
    sed -i "s|$(grep scope ${ConfigPath})|    scope: ${scope}|g" ${ConfigPath}
    ;;
  4)
    ScreenSizeMsgbox
    if $(whiptail --title "WebDAV-SM" \
    --yes-button "å¼€å¯" \
    --no-button "å…³é—­" \
    --yesno "æ˜¯å¦å¼€å¯æˆ–å…³é—­ç”¨æˆ·éªŒè¯?" \
    ${HEIGHT} ${WIDTH})
    if [ ${feedback} == 1 ]
    then
      return
    fi
    then
      sed -i "s/$(grep auth)/'auth: true'/g" ${ConfigPath}
    else
      sed -i "s/$(grep auth)/'auth: false'/g" ${ConfigPath}
    fi
    ScreenSizeMsgbox
    whiptail --title "WebDAV-SM" \
    --msgbox "ä¿®æ”¹å®Œæˆ" \
    ${HEIGHT} ${WIDTH}
    ;;
  0)
    WebDAVMENU
    ;;
  esac
  ;;
  0)
    return 3
  ;;
esac
}

function LoopWebDAVMENU(){
while true
do
  WebDAVMENU
  feedback=$?
  if [ ${feedback} == 3 ]
  then
    exit
  fi
  LoopWebDAVMENU
done
}
LoopWebDAVMENU