#!/bin/env bash
AFHOME=$1
source $AFHOME/Manage/config
MCversion=$(cat version)
ServerName=$2
config=$AFHOME/Manage/config
StartSoftware=$(grep StartSoftware ${config} | sed 's/StartSoftware=//g')
StartSoftwarePath=$AFHOME/Manage/StartSoftware
ServerPropertiesPath=$AFHOME/Manage/BDS/ServerProperties.json

BDSServerConfig(){
OPTIONS=
local Num=$(jq '. | length' ${ServerPropertiesPath})
local Num=$(expr ${Num} - 1)
for ((i=0; i<=${Num}; i++))
do
  local ConfigurationName=$(jq .[${i}].ConfigurationName ${ServerPropertiesPath} | sed 's|"||g')
  local OPTIONS="${OPTIONS} $(expr ${i} + 1) ${ConfigurationName}"
  local OPTIONS=$(echo ${OPTIONS} | sed 's|"||g')
done
ScreenSizeMenu
Number=$(whiptail \
--title "MC-SM" \
--menu "æœåŠ¡å™¨ç‰ˆæœ¬: ${MCversion}" \
${HEIGHT} ${WIDTH} ${OPTION} \
${OPTIONS} \
3>&1 1>&2 2>&3)
feedback=$?
if [ ${feedback} == 1 ]
then
  exit
fi

GrepConfig(){
grep "^${ConfigurationItem}=" server.properties
}
ConfigCheck(){
if ! GrepConfig > /dev/null 2>&1
then
  ScreenSizeMsgbox
  whiptail --title "MC-SM" \
  --msgbox "[é”™è¯¯] é…ç½®é¡¹ä¸å­˜åœ¨" ${HEIGHT} ${WIDTH}
  return
fi
}
ConfigInput(){
OPTIONS=
ConfigCheck
ScreenSizeMsgbox
HEIGHT=$(expr $HEIGHT + 2)
local OldConfig=$(GrepConfig)
local state=$(GrepConfig | awk -F'=' '{print $2}')
local InputData=$(whiptail \
--title "MC-SM" \
--inputbox "${Description}\nå½“å‰è®¾ç½®: [${state}]\nè¯·è¾“å…¥å†…å®¹" \
${HEIGHT} ${WIDTH} \
3>&1 1>&2 2>&3)
feedback=$?
if [ ${feedback} == 1 ]
then
  return
fi
if [[ "${type}" == "String" ]]
then
  if [ -z ${InputData} ]
  then
    ScreenSizeMsgbox
    whiptail --title "MC-SM" \
    --msgbox "[é”™è¯¯] é…ç½®é¡¹å¡«å†™ä¸è§„èŒƒ" ${HEIGHT} ${WIDTH}
    return
  fi
elif [[ "${type}" =~ "Number" ]]
then
  if [[ ! ${InputData} =~ ^[0-9]+$ ]]
  then
    ScreenSizeMsgbox
    whiptail --title "MC-SM" \
    --msgbox "[é”™è¯¯] é…ç½®é¡¹å¡«å†™ä¸è§„èŒƒ" ${HEIGHT} ${WIDTH}
    return
  fi
else
  ScreenSizeMsgbox
  whiptail --title "MC-SM" \
  --msgbox "[é”™è¯¯] é…ç½®é¡¹å¡«å†™ä¸è§„èŒƒ" ${HEIGHT} ${WIDTH}
  return
fi
NewConfig="${ConfigurationItem}=${InputData}"
sed -i "s/${OldConfig}/${NewConfig}/g" server.properties
}
ConfigBoolean(){
OPTIONS=
ConfigCheck
local OldConfig=$(GrepConfig)
if [[ ${OldConfig} == *"true" ]]
then
  local state="å·²å¼€å¯"
elif [[ ${OldConfig} == *"false" ]]
then
  local state="å·²å…³é—­"
else
  ScreenSizeMsgbox
  whiptail --title "MC-SM" \
  --msgbox "[é”™è¯¯] é…ç½®é¡¹å¡«å†™ä¸è§„èŒƒ" ${HEIGHT} ${WIDTH}
  return
fi
ScreenSizeMsgbox
HEIGHT=$(expr $HEIGHT + 1)
if (whiptail --title "MC-SM" \
--yes-button "å¼€å¯" \
--no-button "å…³é—­" \
--yesno "${Description}\nå½“å‰çŠ¶æ€: [${state}]" \
${HEIGHT} ${WIDTH})
then
  NewConfig="${ConfigurationItem}=true"
  sed -i "s/${OldConfig}/${NewConfig}/g" server.properties
else
  NewConfig="${ConfigurationItem}=false"
  sed -i "s/${OldConfig}/${NewConfig}/g" server.properties
fi
}
ConfigOptions(){
OPTIONS=
local Number=$1
ConfigCheck
local OldConfig=$(GrepConfig)
local state=$(GrepConfig | awk -F'=' '{print $2}')
echo ${Number}
local Num=$(jq ".[${Number}].Options | length" ${ServerPropertiesPath})
for ((i=0; i<${Num}; i++))
do
  local Options=$(jq ".[${Number}].Options[${i}]" ${ServerPropertiesPath})
  local OPTIONS="${OPTIONS} ${i} ${Options}"
done
local OPTIONS=$(echo ${OPTIONS} | sed 's|"||g')
ScreenSizeMenu
local Num=$(whiptail \
--title "MC-SM" \
--menu "${Description} å½“å‰: [${state}] ${MCversion}" \
${HEIGHT} ${WIDTH} ${OPTION} \
${OPTIONS} \
3>&1 1>&2 2>&3)

local Config=$(jq ".[${Num}].Options[${Number}]" ${ServerPropertiesPath} | sed 's/"//g')
NewConfig="${ConfigurationItem}=${Config}"
sed -i "s/${OldConfig}/${NewConfig}/g" server.properties
}

Number=$(expr ${Number} - 1)
ConfigurationItem=$(jq .[${Number}].ConfigurationItem ${ServerPropertiesPath} | sed 's/"//g')
type=$(jq .[${Number}].type ${ServerPropertiesPath} | sed 's/"//g')
Description=$(jq .[${Number}].Description ${ServerPropertiesPath} | sed 's/"//g')

if [[ "${type}" == "Boolean" ]]
then
  ConfigBoolean
elif [[ "${type}" == "Options" ]]
then
  ConfigOptions ${Number}
else
  ConfigInput
fi
}

StartCheck(){
Port=$(grep server-port= server.properties | awk -F'=' '{print $2}')
ScreenSizeMsgbox
if bash ${StartSoftwarePath} ${StartSoftware} list 2>&1 | grep -q ${ServerName} > /dev/null 2>&1
then
  if ncat -z -w 1 127.0.0.1 ${Port} -u
  then
    return 0
  else
    whiptail --title "MC-SM" \
    --msgbox "${StartSoftware} [è¢«å ç”¨]" \
    ${HEIGHT} ${WIDTH}
    return 1
  fi
elif ncat -z -w 1 127.0.0.1 ${Port} -u
then
  if bash ${StartSoftwarePath} ${StartSoftware} list 2>&1 | grep -q ${ServerName} > /dev/null 2>&1
  then
    return 0
  else
    whiptail --title "MC-SM" \
    --msgbox "ç«¯å£: ${Port} [è¢«å ç”¨]" \
    ${HEIGHT} ${WIDTH}
    return 1
  fi
else
  return 2
fi
}

WaitingProgressBar(){
  i=0
  ScreenSizeMsgbox
  Port=$(grep 'server-port=' server.properties | awk -F'=' '{print $2}')
  i=0
  {
    until ncat -uzw 0.1 127.0.0.1 ${Port} &> /dev/null
    do
      echo ${i}
      ((i++))
      sleep 0.4s
    done
  } | whiptail --title "MC-SM" --gauge "æœåŠ¡å™¨æ­£åœ¨å¯åŠ¨" ${HEIGHT} ${WIDTH} 0
}

BDSMENU(){
ScreenSizeMenu
Number=$(whiptail \
--title "MC-SM" \
--menu "æœåŠ¡å™¨ç‰ˆæœ¬: ${MCversion}" \
${HEIGHT} ${WIDTH} ${OPTION} \
"1" "ğŸ€ å¯åŠ¨æœåŠ¡å™¨" \
"2" "ğŸŒµ è¿›å…¥æ§åˆ¶å°" \
"3" "ğŸ é…ç½®æœåŠ¡å™¨" \
"4" "ğŸŒ¼ å¤‡ä»½æœåŠ¡å™¨" \
"5" "ğŸŒ· å¸è½½æœåŠ¡å™¨" \
"0" "ğŸ¥ è¿”å›ä¸»èœå•" \
3>&1 1>&2 2>&3)
feedback=$?
if [ ${feedback} == 1 ]
then
  return 3
fi
case ${Number} in
1)
  StartCheck
  if [ $? == 2 ]
  then
    ARCH=$(uname -m)
    case "$ARCH" in
      aarch64|arm64|armv8|armv9)
      Command="cd $AFHOME/Server/${ServerName} && box64 bedrock_server"
      bash ${StartSoftwarePath} ${StartSoftware} start ${ServerName} "${Command}"
      ;;
      x86_64|x64|amd64)
      Command="cd $AFHOME/Server/${ServerName} && bedrock_server"
      bash ${StartSoftwarePath} ${StartSoftware} start ${ServerName} "${Command}"
      ;;
    esac
    WaitingProgressBar
    ScreenSizeMsgbox
    whiptail --title "MC-SM" \
    --msgbox "${ServerName} å¯åŠ¨å®Œæˆ" \
    ${HEIGHT} ${WIDTH}
  elif [ $? == 2 ]
  then
    whiptail --title "MC-SM" \
    --msgbox "${ServerName} [å·²å¯åŠ¨]" \
    ${HEIGHT} ${WIDTH}
  fi
  ;;
2)
  StartCheck
  if [ $? == 0 ]
  then
    bash ${StartSoftwarePath} ${StartSoftware} log ${ServerName}
  elif [ $? == 2 ]
    whiptail --title "MC-SM" \
    --msgbox "${ServerName} [æœªå¯åŠ¨]" \
    ${HEIGHT} ${WIDTH}
  fi
  ;;
3)
  BDSServerConfig
  ;;
4)
  ScreenSizeMenu
  Number=$(whiptail \
  --title "MC-SM" \
  --menu "æœåŠ¡å™¨ç‰ˆæœ¬: ${MCversion}" \
  ${HEIGHT} ${WIDTH} ${OPTION} \
  "1" "ğŸ€ å®Œæ•´å¤‡ä»½" \
  "2" "ğŸŒµ å­˜æ¡£å¤‡ä»½" \
  "3" "ğŸ é…ç½®å¤‡ä»½" \
  3>&1 1>&2 2>&3)
  feedback=$?
  if [ ${feedback} == 1 ]
  then
    return
  fi
  case ${Number} in
  1)
    echo -e ${blue}[${green}*${blue}] ${cyan}å¼€å§‹å¤‡ä»½${background}
    Path=$(pwd)
    cd ..
    ZipName="$(date +%Y%m%d)-${ServerName}-Full"
    tar cf - ${ServerName} | gzip > ${ZipName}.tar.gz
    echo -e ${blue}[${green}*${blue}] ${cyan}æ‰“åŒ…å®Œæˆ${background}
  ;;
  2)
    echo -e ${blue}[${green}*${blue}] ${cyan}å¼€å§‹å¤‡ä»½${background}
    ZipName="$(date +%Y%m%d)-${ServerName}-Worlds"
    tar cf - worlds | gzip > ${ZipName}.tar.gz
    echo -e ${blue}[${green}*${blue}] ${cyan}æ‰“åŒ…å®Œæˆ${background}
  ;;
  3)
    echo -e ${blue}[${green}*${blue}] ${cyan}å¼€å§‹å¤‡ä»½${background}
    mkdir Config
    cp -f server.properties Config/server.properties
    cp -f allowlist.json Config/allowlist.json
    cp -f permissions.json Config/permissions.json
    ZipName="$(date +%Y%m%d)-${ServerName}-Config"
    tar cf - Config | gzip > ${ZipName}.tar.gz
    echo -e ${blue}[${green}*${blue}] ${cyan}æ‰“åŒ…å®Œæˆ${background}
    rm -rf Config
    ;;
  esac
  if [ -d /sd/Download ]
  then
    if [ ! -d /sd/Download/AFBackup ]
    then
      mkdir /sd/Download/AFBackup
    fi
    BackupPath="/sd/Download/AFBackup/${ZipName}.tar.gz"
  elif [ -d /sdcard/Download ]
  then
    if [ ! -d /sdcard/Download/AFBackup ]
    then
      mkdir /sdcard/Download/AFBackup
    fi
    BackupPath="/sdcard/Download/AFBackup/${ZipName}.tar.gz"
  elif [ -d /storage/emulated/0/Download ]
  then
    if [ ! -d /storage/emulated/0/Download ]
    then
      mkdir /storage/emulated/0/Download/AFBackup
    fi
    BackupPath="/sdcard/Download/AFBackup/${ZipName}.tar.gz"
  else
    if [ ! -d $AFHOME/AFBackup ]
    then
      mkdir $AFHOME/AFBackup
    fi
    BackupPath="${AFHOME}/${ZipName}.tar.gz"
  fi
  mv -f ${ZipName}.tar.gz ${BackupPath}
  echo -e ${blue}[${green}*${blue}] ${cyan}å·²å¤‡ä»½è‡³ ${yellow}${BackupPath}${background}
  cd ${Path}
  whiptail --title "MC-SM" \
  --msgbox "å¤‡ä»½å®Œæˆ" \
  ${HEIGHT} ${WIDTH}
  ;;
5)
  ScreenSizeMsgbox
  if ServerName=$(whiptail --title "å¸è½½æœåŠ¡å™¨"  \
  --yes-button "ç¡®è®¤" \
  --no-button "è¿”å›" \
  --yesno "æ˜¯å¦ç¡®è®¤å¸è½½æœåŠ¡å™¨?" ${HEIGHT} ${WIDTH} \
  3>&1 1>&2 2>&3)
  then
    echo -e ${blue}[${red}*${blue}] å€’æ•°${cyan} ${yellow}3${BackupPath}${background}
    sleep 1s
    echo -e ${blue}[${red}*${blue}] å€’æ•°${cyan} ${yellow}2${BackupPath}${background}
    sleep 1s
    echo -e ${blue}[${red}*${blue}] å€’æ•°${cyan} ${yellow}1${BackupPath}${background}
    sleep 1s
    cd $AFHOME
    rm -rf $AFHOME/Server/${ServerName} > /dev/null 2>&1
    ScreenSizeMsgbox
    whiptail --title "MC-SM" \
    --msgbox "å¸è½½å®Œæˆ" \
    ${HEIGHT} ${WIDTH}
  fi
  ;;
0)
  exit
  ;;
esac
}
function LoopMenu(){
while true
do
  BDSMENU
  feedback=$?
  if [ ${feedback} == 3 ]
  then
    exit
  fi
  LoopMenu
done
}
LoopMenuthen
    exit
  fi
  LoopMenu
done
}
LoopMenuENU
  feedback=$?
  if [ ${feedback} == 3 ]
  then
    exit
  fi
  LoopMenu
done
}
LoopMenuu