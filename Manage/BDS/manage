#!/bin/env bash
AFHOME=$1
source $AFHOME/Manage/config
MCversion=$(cat version)
ServerName=$2
config=$AFHOME/Manage/config
StartSoftware=$(grep StartSoftware ${config} | sed 's/StartSoftware=//g')
StartSoftwarePath=$AFHOME/Manage/StartSoftware
BDSServerConfig(){
OPTIONS=
Num=$(jq '. | length' ServerProperties.json)
Num=$(expr 18 - 1)
for ((i=1; i<=${Num}; i++))
do
  ConfigurationName=$(jq .[${i}].ConfigurationName ServerProperties.json)
  OPTIONS="${OPTIONS} $(expr ${i} - 1) ${ConfigurationName}"
  OPTIONS=$(echo ${OPTIONS} | sed 's|"||g')
done
ScreenSizeMenu
Number=$(whiptail \
--title "MC-SM" \
--menu "æœåŠ¡å™¨ç‰ˆæœ¬: ${MCversion}" \
${HEIGHT} ${WIDTH} ${OPTION} \
${OPTIONS} \
3>&1 1>&2 2>&3)

ConfigInput(){
ScreenSizeMsgbox

}

ConfigChoose(){
if ! grep -q ${ConfigurationItem}
then
  ScreenSizeMsgbox
  whiptail --title "ç™½ç‹-Script" \
  --msgbox "[é”™è¯¯] é…ç½®é¡¹ä¸å­˜åœ¨" ${HEIGHT} ${WIDTH}
  return
fi
ScreenSizeMsgbox
OldConfig=$(grep "${ConfigurationItem}=")

if $(dialog --title "MC-SM-Config" \
--yes-button "å¼€å¯" \
--no-button "å…³é—­" \
--yesno ${Description} \
${HEIGHT} ${WIDTH})
then
  OldConfig=$(grep "${ConfigurationItem}=")
  sed -i "s/${OldConfig}/${NewConfig}/g" server.properties
else
  
fi


}


ConfigurationItem=$(jq .[$(expr ${Number} - 1)].ConfigurationItem)
type=$(jq .[$(expr ${Number} - 1)].type)
Description=$(jq .[$(expr ${Number} - 1)].Description)

case ${Number} in

esac




}
ScreenSizeMenu
Number=$(whiptail \
--title "MC-SM" \
--menu "æœåŠ¡å™¨ç‰ˆæœ¬: ${MCversion}" \
${HEIGHT} ${WIDTH} ${OPTION} \
"1" "ğŸ€ å¯åŠ¨æœåŠ¡å™¨" \
"2" "ğŸŒ¸ å…³é—­æœåŠ¡å™¨" \
"3" "ğŸŒµ æ—¥å¿—æœåŠ¡å™¨" \
"4" "ğŸ é…ç½®æœåŠ¡å™¨" \
"5" "ğŸŒ¼ å¤‡ä»½æœåŠ¡å™¨" \
"6" "ğŸŒ· å¸è½½æœåŠ¡å™¨" \
"0" "ğŸ¥ è¿”å›ä¸»èœå•" \
3>&1 1>&2 2>&3)
case ${Number} in
1)
  ARCH=$(uname -m)
  case "$ARCH" in
    aarch64|arm64|armv8|armv9)
    Command="cd $AFHOME/Server/${ServerName} && box64 bedrock_server"
    bash ${StartSoftwarePath} ${StartSoftware} start ${ServerName} "${Command}"
    ;;
    x86_64|x64|amd64)
    Command="cd $AFHOME/Server/${ServerName} && bedrock_server"
    bash ${StartSoftwarePath} ${StartSoftware} start ${ServerName} "${Command}"
    ;;
  esac
  ;;
2)
  bash ${StartSoftwarePath} ${StartSoftware} stop ${ServerName}
  ;;
3)
  bash ${StartSoftwarePath} ${StartSoftware} log ${ServerName}
  ;;
4)
  BDSServerConfig
  ;;
5)
  ScreenSizeMsgbox
  echo -e ${blue}[${green}*${blue}] ${cyan}å¼€å§‹å¤‡ä»½${background}
  Path=$(pwd)
  cd ..
  ZipName="$(date +%Y%m%d)-${ServerName}"
  tar cf - ${ServerName} | gzip > ${ZipName}.tar.gz    
  echo -e ${blue}[${green}*${blue}] ${cyan}å¤‡ä»½å®Œæˆ${background}
  if [ -d /sd ] || [ -d /sdcard ]
  then
    if [ ! -d /sdcard/Download/AFBackup ]
    then
      mkdir /sdcard/Download/AFBackup
    fi
    BackupPath="/sdcard/Download/AFBackup/${ZipName}.tar.gz"
  else
    if [ ! -d ../AFBackup ]
    then
      mkdir ../AFBackup
    fi
    BackupPath="${AFHOME}/${ZipName}.tar.gz"
  fi
  mv -f ${ZipName}.tar.gz ${BackupPath}
  echo -e ${blue}[${green}*${blue}] ${cyan}å·²å¤‡ä»½è‡³ ${yellow}${BackupPath}${background}
  cd ${Path}
  ;;
6)
  ScreenSizeMsgbox
  if ! ServerName=$(whiptail --title "å¸è½½æœåŠ¡å™¨"  \
  --yes-button "ç¡®è®¤" \
  --no-button "è¿”å›" \
  --yesno "æ˜¯å¦ç¡®è®¤å¸è½½æœåŠ¡å™¨?" ${HEIGHT} ${WIDTH} \
  3>&1 1>&2 2>&3)
  then
    echo -e ${blue}[${red}*${blue}] å€’æ•°${cyan} ${yellow}3${BackupPath}${background}
    sleep 1s
    echo -e ${blue}[${red}*${blue}] å€’æ•°${cyan} ${yellow}2${BackupPath}${background}
    sleep 1s
    echo -e ${blue}[${red}*${blue}] å€’æ•°${cyan} ${yellow}1${BackupPath}${background}
    sleep 1s
    cd $AFHOME
    rm -rf $AFHOME/Server/${ServerName}
    ScreenSizeMsgbox
    whiptail --title "ç™½ç‹-Script" \
    --msgbox "å¸è½½å®Œæˆ" \
    ${HEIGHT} ${WIDTH}
  fi
  ;;
esac